import{j as e,af as fe,ag as je,B as o,W as pe,h as a,ah as ge,aF as W,ay as k,ac as y,A,aj as ye,k as H,U as S,at as z,C as J,N as K,a8 as j,u as be,Q as ve,b7 as we,b8 as V,bv as Fe,q as Y,bw as Ce,bx as Se,I as C,am as ze,S as Ae,by as Me,av as Be,b6 as T,az as _,aK as q}from"./mui-vendor-D4OjBZQt.js";import{a as n}from"./react-vendor-DYr15v6v.js";import{p as g,r as ke}from"./pdfStorageService-CPryU-Rx.js";import"./firebase-vendor-OxXAdhiL.js";import"./index-BIOtAz8Z.js";import"./redux-vendor-CLOwJCHO.js";import"./utils-vendor-CFocuF-S.js";import"./pdf-vendor-CApBJrGQ.js";const De=r=>{if(r===0)return"0 Bytes";const l=1024,d=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(l));return parseFloat((r/Math.pow(l,i)).toFixed(2))+" "+d[i]},Ie=({open:r,onClose:l,onConfirm:d,itemType:i,itemName:u,folderStats:c})=>{const f=i==="folder",h=c&&c.fileCount>1;return e.jsxs(fe,{open:r,onClose:l,maxWidth:"sm",fullWidth:!0,"aria-labelledby":"delete-dialog-title",children:[e.jsx(je,{id:"delete-dialog-title",children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(pe,{color:"warning"}),e.jsxs(a,{variant:"h6",children:["Delete ",f?"Folder":"File"]})]})}),e.jsxs(ge,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[f?e.jsx(W,{color:"primary",sx:{fontSize:40}}):e.jsx(k,{color:"error",sx:{fontSize:40}}),e.jsxs(o,{children:[e.jsx(a,{variant:"h6",component:"div",sx:{wordBreak:"break-word"},children:u}),c&&e.jsxs(o,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx(y,{label:`${c.fileCount} file${c.fileCount!==1?"s":""}`,size:"small",variant:"outlined"}),e.jsx(y,{label:De(c.totalSize),size:"small",variant:"outlined"})]})]})]}),e.jsx(A,{severity:"warning",sx:{mb:2},children:e.jsx(a,{variant:"body2",children:f?e.jsxs(e.Fragment,{children:["This will permanently delete the folder and"," ",e.jsx("strong",{children:c?`all ${c.fileCount} file${c.fileCount!==1?"s":""}`:"all files"})," ","inside it."]}):"This will permanently delete the file."})}),h&&e.jsx(A,{severity:"error",sx:{mb:2},children:e.jsxs(a,{variant:"body2",fontWeight:"bold",children:["⚠️ This folder contains ",c==null?void 0:c.fileCount," files. This action cannot be undone!"]})}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Are you sure you want to continue? This action cannot be undone."})]}),e.jsxs(ye,{sx:{p:2},children:[e.jsx(H,{onClick:l,variant:"outlined",children:"Cancel"}),e.jsxs(H,{onClick:d,variant:"contained",color:"error",autoFocus:!0,children:["Delete ",f?"Folder":"File"]})]})]})},Pe=r=>{if(r===0)return"0 Bytes";const l=1024,d=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(l));return parseFloat((r/Math.pow(l,i)).toFixed(2))+" "+d[i]},Ee=()=>{const[r,l]=n.useState(null),[d,i]=n.useState(!0),[u,c]=n.useState(null),f=async()=>{try{i(!0),c(null);const h=await g.listUserFolders();let p=0,b=0;if(Array.isArray(h))for(const m of h)p+=m.fileCount,b+=m.totalSize;else console.warn("Expected folders to be an array, got:",typeof h);l({totalFolders:Array.isArray(h)?h.length:0,totalFiles:p,totalSize:b})}catch(h){const p=h instanceof Error?h.message:"Failed to load storage statistics";c(p),console.error("Error loading storage stats:",h)}finally{i(!1)}};return n.useEffect(()=>{f()},[]),d?e.jsx(S,{children:e.jsx(z,{children:e.jsx(o,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(J,{size:24})})})}):u?e.jsxs(A,{severity:"error",children:["Failed to load storage statistics: ",u]}):r?e.jsx(S,{children:e.jsxs(z,{children:[e.jsxs(a,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{color:"primary"}),"Storage Overview"]}),e.jsxs(j,{container:!0,spacing:2,children:[e.jsx(j,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{textAlign:"center"},children:[e.jsx(W,{color:"primary",sx:{fontSize:40,mb:1}}),e.jsx(a,{variant:"h4",component:"div",children:r.totalFolders}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Folder",r.totalFolders!==1?"s":""]})]})}),e.jsx(j,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{textAlign:"center"},children:[e.jsx(k,{color:"error",sx:{fontSize:40,mb:1}}),e.jsx(a,{variant:"h4",component:"div",children:r.totalFiles}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["File",r.totalFiles!==1?"s":""]})]})}),e.jsx(j,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{textAlign:"center"},children:[e.jsx(K,{color:"success",sx:{fontSize:40,mb:1}}),e.jsx(a,{variant:"h4",component:"div",children:Pe(r.totalSize)}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Total Size"})]})})]}),r.totalFiles===0&&e.jsx(o,{sx:{mt:2,textAlign:"center"},children:e.jsx(y,{label:"No files uploaded yet",variant:"outlined",color:"default"})})]})}):null},$=r=>{if(r===0)return"0 Bytes";const l=1024,d=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(l));return parseFloat((r/Math.pow(l,i)).toFixed(2))+" "+d[i]},N=r=>{const d=Math.floor((new Date().getTime()-r.getTime())/(1e3*60));if(d<1)return"Just now";if(d<60)return`${d}m ago`;const i=Math.floor(d/60);if(i<24)return`${i}h ago`;const u=Math.floor(i/24);return u<7?`${u}d ago`:r.toLocaleDateString()},Re=()=>{const r=be(),[l,d]=n.useState(""),[i,u]=n.useState([]),[c,f]=n.useState([]),[h,p]=n.useState([]),[b,m]=n.useState(!0),[O,v]=n.useState(null),[D,Q]=n.useState(!1),[X,Z]=n.useState([]),[ee,se]=n.useState({}),[te,G]=n.useState(!1),[re,I]=n.useState(!1),[x,P]=n.useState(null),[ae,M]=n.useState(!1),[ne,E]=n.useState(""),[oe,L]=n.useState("success");n.useEffect(()=>{(async()=>{try{const t=await ke.hasAdminAccess();G(t)}catch(t){console.error("Error checking admin access:",t),G(!1)}})()},[]);const B=async()=>{try{if(m(!0),v(null),l===""){const s=await g.listAllFolders();f(s),p([])}else{const s=await g.listFolderContents(l);p(s),f([])}}catch(s){const t=s instanceof Error?s.message:"Failed to load storage contents";v(t),console.error("Error loading storage contents:",s)}finally{m(!1)}},le=()=>{if(l===""){u([]);return}const s=l.split("/").filter(Boolean),t=[];let F="";for(let w=2;w<s.length;w++)F+=(F?"/":"")+s[w],t.push({name:s[w],path:`pdfs/${s[1]}/${F}`});u(t)},U=s=>{d(s),le()},ie=s=>{U(s.path)},ce=async()=>{try{m(!0),v(null);const s={page:1,pageSize:50,sortBy:"uploadDate",sortOrder:"desc"},t=await g.listAllUserPdfs(s);Z(t.pdfs);const F=await g.getUserDetailsForPdfs(t.pdfs.map(w=>w.fileId));se(F)}catch(s){const t=s instanceof Error?s.message:"Failed to load PDFs";v(t),console.error("Error loading all user PDFs:",s)}finally{m(!1)}},R=(s,t)=>{P({type:s,item:t}),I(!0)},de=async()=>{if(x)try{m(!0),x.type==="folder"?(await g.deleteFolderRecursive(x.item.path),E("Folder deleted successfully")):(await g.deleteFile(x.item.path),E("File deleted successfully")),L("success"),M(!0),await B()}catch(s){const t=s instanceof Error?s.message:"Failed to delete item";v(t),E(t),L("error"),M(!0)}finally{m(!1),I(!1),P(null)}},xe=s=>{window.open(s.downloadUrl,"_blank")},he=async s=>{try{Q(s),m(!0),s?await ce():await B()}catch(t){console.error("Error toggling view:",t)}};n.useEffect(()=>{B()},[l]);const ue=()=>e.jsx(j,{container:!0,spacing:2,children:X.map(s=>{const t=ee[s.metadata.userId]||{};return e.jsx(j,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(S,{children:[e.jsxs(z,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(Me,{src:t.photoURL,sx:{mr:2,width:40,height:40},children:t.displayName?t.displayName[0]:e.jsx(Be,{})}),e.jsxs(o,{children:[e.jsx(a,{variant:"subtitle1",children:t.displayName||"Unknown User"}),e.jsx(a,{variant:"body2",color:"text.secondary",children:t.email})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(k,{color:"error",sx:{mr:1}}),e.jsx(a,{variant:"subtitle2",noWrap:!0,children:s.metadata.originalFileName})]}),e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(y,{label:$(s.metadata.fileSize),size:"small",variant:"outlined"}),e.jsx(y,{label:N(new Date(s.metadata.uploadedAt)),size:"small",variant:"outlined"})]})]}),e.jsx(T,{children:e.jsx(C,{color:"primary",onClick:()=>window.open(s.downloadUrl,"_blank"),children:e.jsx(_,{})})})]})},s.fileId)})}),me=()=>e.jsxs(j,{container:!0,spacing:2,children:[c.map(s=>e.jsx(j,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(S,{sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:r.shadows[4]}},children:[e.jsxs(z,{onClick:()=>ie(s),sx:{pb:1},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(W,{color:"primary",sx:{mr:1,fontSize:32}}),e.jsx(a,{variant:"h6",component:"div",noWrap:!0,children:s.name})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:[s.fileCount," file",s.fileCount!==1?"s":""]}),e.jsx(a,{variant:"body2",color:"text.secondary",children:$(s.totalSize)}),e.jsx(y,{label:N(s.lastModified),size:"small",sx:{mt:1}})]}),e.jsx(T,{sx:{pt:0},children:e.jsx(C,{size:"small",color:"error",onClick:t=>{t.stopPropagation(),R("folder",s)},"aria-label":"delete folder",children:e.jsx(q,{})})})]})},s.path)),h.map(s=>e.jsx(j,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(S,{sx:{transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:r.shadows[4]}},children:[e.jsxs(z,{sx:{pb:1},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(k,{color:"error",sx:{mr:1,fontSize:32}}),e.jsx(a,{variant:"h6",component:"div",noWrap:!0,title:s.name,children:s.name})]}),e.jsx(a,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:$(s.size)}),e.jsx(y,{label:N(s.lastModified),size:"small",sx:{mt:1}})]}),e.jsxs(T,{sx:{pt:0,justifyContent:"space-between"},children:[e.jsx(C,{size:"small",color:"primary",onClick:()=>xe(s),"aria-label":"download file",children:e.jsx(_,{})}),e.jsx(C,{size:"small",color:"error",onClick:()=>R("file",s),"aria-label":"delete file",children:e.jsx(q,{})})]})]})},s.path))]});return e.jsxs(ve,{maxWidth:"lg",sx:{py:3},children:[e.jsxs(o,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(o,{children:[e.jsx(a,{variant:"h4",component:"h1",gutterBottom:!0,children:"Storage Management"}),e.jsx(a,{variant:"body1",color:"text.secondary",children:D?"All Users' Files":"Manage your uploaded PDF files and folders"})]}),te&&e.jsxs(we,{value:D,exclusive:!0,onChange:(s,t)=>t!==null&&he(t),color:"primary","data-testid":"toggle-group",children:[e.jsx(V,{value:!1,"data-testid":"toggle-button-false",children:"My Files"}),e.jsx(V,{value:!0,"data-testid":"toggle-button-true",children:"All Users"})]})]}),e.jsx(o,{sx:{mb:3},children:e.jsx(Ee,{})}),e.jsx(o,{sx:{mb:3},children:e.jsxs(Fe,{separator:e.jsx(Se,{fontSize:"small"}),"aria-label":"folder navigation",children:[e.jsxs(Y,{component:"button",variant:"body1",onClick:()=>U(""),sx:{display:"flex",alignItems:"center",textDecoration:"none","&:hover":{textDecoration:"underline"}},children:[e.jsx(Ce,{sx:{mr:.5},fontSize:"inherit"}),"All Files"]}),i.map(s=>e.jsx(Y,{component:"button",variant:"body1",onClick:()=>U(s.path),sx:{textDecoration:"none","&:hover":{textDecoration:"underline"}},children:s.name},s.path))]})}),e.jsx(o,{sx:{mb:3,display:"flex",justifyContent:"flex-end"},children:e.jsx(C,{onClick:B,disabled:b,"aria-label":"refresh",color:"primary",children:e.jsx(ze,{})})}),O&&e.jsx(A,{severity:"error",sx:{mb:3},onClose:()=>v(null),children:O}),b&&e.jsx(o,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(J,{})}),!b&&(D?ue():me()),e.jsx(Ie,{open:re,onClose:()=>{I(!1),P(null)},onConfirm:de,itemType:(x==null?void 0:x.type)||"file",itemName:(x==null?void 0:x.item.name)||"",folderStats:(x==null?void 0:x.type)==="folder"?{fileCount:x.item.fileCount,totalSize:x.item.totalSize}:void 0}),e.jsx(Ae,{open:ae,autoHideDuration:6e3,onClose:()=>M(!1),children:e.jsx(A,{onClose:()=>M(!1),severity:oe,sx:{width:"100%"},children:ne})})]})};export{Re as StorageManagementPage};
