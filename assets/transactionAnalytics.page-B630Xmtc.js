var q=Object.defineProperty;var V=(n,e,s)=>e in n?q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var f=(n,e,s)=>V(n,typeof e!="symbol"?e+"":e,s);import{j as t,T as P,ac as w,aO as K,aP as _,v as $,ax as G,ab as O,a8 as h,a2 as N,h as y,B as S,G as Q,ae as H,Q as J,O as X,C as Y,D as Z,U as ee,at as te,aQ as re,k as U,aR as se,aS as ae,A as oe,aT as ie,aU as z}from"./mui-vendor-D4OjBZQt.js";import{a as j,i as ne}from"./react-vendor-DYr15v6v.js";import{P as ce,u as le,a as M,G as de,n as ue,H as he}from"./index-BIOtAz8Z.js";import{D as W}from"./DataTable-EonKnU6y.js";import{F as v}from"./FormattedCurrency-Cr38E1t8.js";import{a as pe,u as F}from"./utils-vendor-CFocuF-S.js";import"./redux-vendor-CLOwJCHO.js";import"./firebase-vendor-OxXAdhiL.js";import"./pdf-vendor-CApBJrGQ.js";class fe{constructor(e,s){f(this,"transactions");f(this,"productPrices");this.transactions=e.filter(a=>!!a&&!!a.type),this.productPrices=s}isExpense(e){return e?["adjustment","refund","service fee","shipping services","returned","return_requested"].includes(e.toLowerCase()):!1}isSale(e){return e?["order","delivered","in_transit","return_cancelled"].includes(e.toLowerCase()):!1}getCostPrice(){return 0}async analyze(){var a;const e={totalSales:0,totalExpenses:0,expensesByCategory:{},salesByProduct:{},totalProfit:0,totalUnits:0,totalCost:0,profitBeforeCost:0,costPriceSources:{product:0,category:0,default:0},analyzedTransactions:[]},s=[];for(const r of this.transactions){const o=r.type||"",d=r.sku,i=r.quantity,c=r.sellingPrice,l=r.total||0;if(s.push({...r}),this.isExpense(o)){const x=o==null?void 0:o.toLowerCase(),b=r.expenses.shippingFee+r.expenses.marketplaceFee+r.expenses.otherFees;e.expensesByCategory[x]=(e.expensesByCategory[x]||0)+b,e.totalExpenses+=b}if(this.isSale(o)){e.totalSales+=c;const x=r.expenses.shippingFee+r.expenses.marketplaceFee+r.expenses.otherFees;e.totalExpenses+=x;const b=0;if(!e.salesByProduct[d]){const k=(a=this.productPrices)==null?void 0:a.get(d.toLowerCase());e.salesByProduct[d]={units:0,amount:0,profit:0,profitPerUnit:0,name:(k==null?void 0:k.name)||d,costPriceSource:"default"}}const g=e.salesByProduct[d];g.units+=i,g.amount+=l,e.totalUnits+=i;const C=b*i;e.totalCost+=C;const D=l-C;g.profit+=D,g.units>0&&(g.profitPerUnit=g.profit/g.units),e.profitBeforeCost+=l,e.totalProfit+=D}}return e.analyzedTransactions=s,e}}const xe=({transactions:n})=>{const e=r=>`₹${r.toFixed(2)}`,s=n.map(r=>({transactionId:r.transactionId||"",sku:r.sku||"",productName:r.product.name||r.description||"Unknown Product",platform:r.platform||"",sellingPrice:r.sellingPrice||0,total:r.total||0,productCost:0,costPriceSource:"none",type:r.type||""})),a=[{id:"transactionId",label:"#",filter:!0},{id:"sku",label:"SKU",filter:!0},{id:"productName",label:"Product Name",filter:!0},{id:"platform",label:"Platform",filter:!0},{id:"sellingPrice",label:"Selling Price",align:"right",filter:!0,format:r=>e(r)},{id:"total",label:"Earnings",align:"right",format:r=>e(r)},{id:"productCost",label:"Product Cost",align:"right",format:r=>e(r)},{id:"costPriceSource",label:"Price Source",filter:!0,format:r=>{const o=r;let d="inherit";return o==="product"&&(d="#1976d2"),o==="category"&&(d="#9c27b0"),t.jsx("span",{style:{fontWeight:o==="default"?"normal":"bold",color:d},children:o})}},{id:"type",label:"Type",filter:!0}];return t.jsx(W,{columns:a,data:s,defaultSortColumn:"transactionId",defaultSortDirection:"asc",rowsPerPageOptions:[15,30,50],defaultRowsPerPage:30})},ge=({transactions:n,summary:e})=>{const s=i=>`₹${i.toFixed(2)}`,a=i=>{switch(i){case"product":return"success";case"category":return"primary";case"default":default:return"warning"}},r=i=>{switch(i){case"product":return"Custom cost price defined directly on the product";case"category":return"Cost price inherited from product category";case"default":default:return"Default cost price (no custom price or category price available)"}},o=j.useMemo(()=>{const i=new Map;return e?Object.entries(e.salesByProduct).forEach(([c,l])=>{i.set(c,{sku:c,description:l.description||l.name||c,units:l.units,sales:l.amount,cost:e.totalCost*(l.units/e.totalUnits),profit:l.profit,costPriceSource:l.costPriceSource})}):n.forEach(c=>{const l=c.sku,x=i.get(l)||{sku:l,description:c.description||l,units:0,sales:0,cost:0,profit:0};x.units+=c.quantity,x.sales+=c.sellingPrice*c.quantity;const b=0;x.cost+=b*c.quantity;const g=c.expenses.shippingFee+c.expenses.marketplaceFee+c.expenses.otherFees,C=c.sellingPrice*c.quantity-b*c.quantity-g;x.profit+=C,i.set(l,x)}),Array.from(i.values())},[n,e]),d=[{id:"sku",label:"SKU",filter:!0},{id:"description",label:"Description",filter:!0},{id:"units",label:"Units",align:"right",format:i=>String(i)},{id:"sales",label:"Sales",align:"right",format:i=>s(i)},{id:"cost",label:"Cost",align:"right",format:i=>s(i)},{id:"profit",label:"Profit",align:"right",format:i=>s(i)},{id:"costPriceSource",label:"Price Source",format:i=>{const c=i||"default";return t.jsx(P,{title:r(c),children:t.jsx(w,{size:"small",label:c.charAt(0).toUpperCase()+c.slice(1),color:a(c),variant:"outlined"})})}}];return t.jsx(W,{columns:d,data:o,defaultSortColumn:"sku",defaultSortDirection:"asc",rowsPerPageOptions:[10,25,50],defaultRowsPerPage:25})},me=({summary:n})=>{const e=n.costPriceSources||{product:0,category:0,default:0},s=e.product+e.category+e.default,a=[{label:"Total Sales",value:t.jsx(v,{value:n.totalSales}),color:"primary",icon:t.jsx(K,{color:"primary",fontSize:"large"})},{label:"Total Expenses",value:t.jsx(v,{value:Math.abs(n.totalExpenses)}),color:"error",icon:t.jsx(_,{color:"error",fontSize:"large"})},{label:"Total Units Sold",value:n.totalUnits,color:"secondary",icon:t.jsx($,{color:"secondary",fontSize:"large"})},{label:"Profit Before Cost",value:t.jsx(v,{value:n.profitBeforeCost}),color:"info",icon:t.jsx(G,{color:"info",fontSize:"large"})},{label:"Total Cost",value:t.jsx(v,{value:n.totalCost}),color:"success",icon:t.jsx(O,{color:"success",fontSize:"large"})},{label:"Total Profit",value:t.jsx(v,{value:n.totalProfit}),color:"success",icon:t.jsx(O,{color:"success",fontSize:"large"})}];return t.jsxs(h,{container:!0,spacing:2,children:[t.jsx(h,{item:!0,xs:12,children:t.jsx(h,{container:!0,spacing:2,children:a.map((r,o)=>t.jsx(h,{item:!0,xs:12,sm:6,md:4,lg:2,children:t.jsx(N,{sx:{p:2,textAlign:"center",borderLeft:"5px solid",borderColor:r.color,boxShadow:3,"flex-grow":1,width:"100%"},children:t.jsxs(h,{container:!0,spacing:2,alignItems:"center",justifyContent:"center",children:[t.jsx(h,{item:!0,md:3,children:r.icon}),t.jsxs(h,{item:!0,children:[t.jsx(y,{variant:"subtitle1",color:"textSecondary",children:r.label}),t.jsx(y,{variant:"h5",color:r.color,children:r.value})]})]})})},o))})}),t.jsx(h,{item:!0,xs:12,children:t.jsxs(N,{sx:{p:2,boxShadow:3},children:[t.jsxs(S,{sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(Q,{color:"primary",sx:{mr:1}}),t.jsx(y,{variant:"h6",children:"Cost Price Sources"}),t.jsx(P,{title:"Shows how many products are using different cost price sources",children:t.jsx(H,{fontSize:"small",sx:{ml:1,color:"text.secondary"}})})]}),t.jsxs(h,{container:!0,spacing:2,children:[t.jsx(h,{item:!0,children:t.jsx(P,{title:"Products with custom cost prices defined",children:t.jsx(w,{label:`Product: ${e.product}`,color:"success",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(P,{title:"Products inheriting cost price from category",children:t.jsx(w,{label:`Category: ${e.category}`,color:"primary",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(P,{title:"Products using default cost price (no custom or category price)",children:t.jsx(w,{label:`Default: ${e.default}`,color:"warning",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(P,{title:"Total products analyzed",children:t.jsx(w,{label:`Total: ${s}`,variant:"outlined",sx:{fontWeight:"bold"}})})})]})]})})]})};class ye{constructor(e){f(this,"file");f(this,"transactions",[]);f(this,"ordersData");this.file=e,this.rowToTransaction=this.rowToTransaction.bind(this),this.transformTransactions=this.transformTransactions.bind(this),this.parseCsvData=this.parseCsvData.bind(this),this.reponseAdapter=this.reponseAdapter.bind(this),this.process=this.process.bind(this)}parseCurrencyValue(e){if(!e)return 0;const s=e.replace(/[₹,\s]/g,"").trim(),a=parseFloat(s);return isNaN(a)?0:a}async parseCsvData(){this.ordersData=await new Promise((e,s)=>{ce.parse(this.file,{complete:e,header:!0,skipEmptyLines:!0,beforeFirstChunk:function(a){let o=a.indexOf(`
`);for(let d=1;d<11&&o>0;++d)o=a.indexOf(`
`,o+1);return a.substring(o+1)},error:s})})}transformTransactions(){if(!this.ordersData)throw new Error("No data to transform");this.transactions=this.ordersData.data.filter(e=>e&&typeof e=="object"&&e.type).map(this.rowToTransaction).filter(e=>!!e&&!!e.type&&!!e.sku)}rowToTransaction(e){var l;const s=e.Sku||e.sku||"",a=(l=e.type)==null?void 0:l.toLowerCase();if(!a||!["order","shipped","refund"].includes(a))return null;const r=this.parseCurrencyValue(e["product sales"]),o=this.parseCurrencyValue(e["selling fees"]),d=this.parseCurrencyValue(e["fba fees"]),i=this.parseCurrencyValue(e["other transaction fees"]),c=this.parseCurrencyValue(e.total);return{transactionId:e["order id"],platform:"amazon",orderDate:e["date/time"],sku:s,quantity:Number(e.quantity)||0,sellingPrice:r,description:e.description||"",type:a,marketplace:"Amazon",total:c,productSales:e["product sales"]||"0",sellingFees:Math.abs(o).toString(),fbaFees:Math.abs(d).toString(),otherTransactionFees:Math.abs(i).toString(),other:e.other||"0",expenses:{shippingFee:0,marketplaceFee:Math.abs(o),otherFees:Math.abs(d)+Math.abs(i)},product:{name:e.description||"",sku:s,description:e.description||"",platform:"amazon",metadata:{},visibility:"visible",sellingPrice:r},metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},hash:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}}reponseAdapter(){return this.transactions}async process(){return await this.parseCsvData(),this.transformTransactions(),this.reponseAdapter()}}class be{constructor(e){f(this,"file");f(this,"workbook");f(this,"ordersData",[]);f(this,"transactions",[]);f(this,"categoryMapping",new Map);this.file=e,this.rowToTransaction=this.rowToTransaction.bind(this),this.transformOrdersData=this.transformOrdersData.bind(this),this.parseOrdersSheet=this.parseOrdersSheet.bind(this),this.readWorkbook=this.readWorkbook.bind(this),this.reponseAdapter=this.reponseAdapter.bind(this),this.process=this.process.bind(this),this.extractCategoryInfo=this.extractCategoryInfo.bind(this)}parseCurrencyValue(e){return e?typeof e=="number"?e:Number(e.replace(/[^\d.-]/g,""))||0:0}async readWorkbook(){try{const e=await this.file.arrayBuffer();this.workbook=pe(e,{type:"array"});const s="Orders P&L";if(!this.workbook.SheetNames.includes(s))throw new Error("Required sheet 'Orders P&L' not found");const a=this.workbook.Sheets[s];if(!a||F.sheet_to_json(a).length===0)throw new Error("No data found in Orders P&L sheet");this.workbook.SheetNames.includes("Categories")&&await this.extractCategoryInfo()}catch(e){throw e instanceof Error?e:new Error("Failed to read workbook")}}async extractCategoryInfo(){if(!(!this.workbook||!this.workbook.SheetNames.includes("Categories")))try{const e=this.workbook.Sheets.Categories,s=F.sheet_to_json(e);s&&s.length>0&&s.forEach(a=>{a.SKU&&a.CategoryID&&this.categoryMapping.set(a.SKU,a.CategoryID)})}catch(e){console.error("Error extracting category information:",e)}}parseOrdersSheet(){var s;const e=(s=this.workbook)==null?void 0:s.Sheets["Orders P&L"];if(!e)throw new Error("Required sheet 'Orders P&L' not found");if(this.ordersData=F.sheet_to_json(e),!this.ordersData||this.ordersData.length===0)throw new Error("No data found in Orders P&L sheet")}transformOrdersData(){if(!this.ordersData)throw new Error("No orders data to transform");this.transactions=this.ordersData.map(this.rowToTransaction).filter(e=>!!e)}getCategoryId(e){if(e["SKU Name"]&&this.categoryMapping.has(e["SKU Name"]))return this.categoryMapping.get(e["SKU Name"]);if(e["Product Category"])return e["Product Category"]}rowToTransaction(e){if(!e["Order ID"])return null;const s=this.getCategoryId(e),a=this.parseCurrencyValue(e["Final Selling Price (incl. seller opted in default offers)"]);return{transactionId:e["Order ID"],sku:e["SKU Name"],description:e["SKU Name"],platform:"flipkart",marketplace:"Flipkart",type:"delivered",orderDate:e["Order Date"],quantity:e["Gross Units"],sellingPrice:a,orderStatus:e["Order Status"],total:this.parseCurrencyValue(e["Net Earnings (INR)"]),productSales:this.parseCurrencyValue(e["Accounted Net Sales (INR)"]),accNetSales:this.parseCurrencyValue(e["Bank Settlement [Projected] (INR)"]),expenses:{shippingFee:this.parseCurrencyValue(e["Shipping Fee (INR)"]),marketplaceFee:this.parseCurrencyValue(e["Commission (INR)"]),otherFees:this.parseCurrencyValue(e["Total Expenses (INR)"])},product:{name:e["SKU Name"]||"",sku:e["SKU Name"],description:e["SKU Name"]||"",platform:"flipkart",categoryId:s,metadata:{lastImportedFrom:"flipkart",listingStatus:"active",moq:"1"},visibility:"visible",sellingPrice:a},metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},hash:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}}reponseAdapter(){return this.transactions}async process(){return await this.readWorkbook(),this.parseOrdersSheet(),this.transformOrdersData(),this.reponseAdapter()}}class Se{constructor(e){f(this,"reportType");f(this,"file");if(!e)throw new Error("No file selected!");this.file=e,this.identify()}identify(){var e;(e=this.file)!=null&&e.name.endsWith(".xlsx")?this.reportType="Flipkart":this.reportType="Amazon"}async extract(){if(!this.file)throw new Error("No file selected!");switch(this.reportType){case"Flipkart":return await new be(this.file).process();case"Amazon":return await new ye(this.file).process();default:throw new Error("Unsupported file type")}}}function B(n){const{children:e,value:s,index:a,...r}=n;return t.jsx("div",{hidden:s!==a,...r,children:s===a&&t.jsx(S,{sx:{p:0},children:e})})}const Ae=()=>{var A,E;const n=le(),{items:e,loading:s,error:a}=M(p=>p.transactions),{items:r}=M(p=>p.products),[o,d]=j.useState(null),[i,c]=j.useState(0),[l,x]=j.useState({minDate:null,maxDate:null}),[b,g]=j.useState(!1),C=ne();j.useEffect(()=>{(async()=>{try{await Promise.all([n(de()),n(ue({}))])}catch{}})()},[n]),j.useEffect(()=>{(async()=>{if(e.length>0&&r.length>0)try{g(!0);const u=new Map(r.map(m=>[m.sku.toLowerCase(),m])),T=e.map(m=>({...m,product:{...m.product,...u.get(m.sku.toLowerCase())}})),I=T.map(m=>new Date(m.orderDate));x({minDate:new Date(Math.min(...I.map(m=>m.getTime()))),maxDate:new Date(Math.max(...I.map(m=>m.getTime())))});const L=await new fe(T,u).analyze();d(L)}catch(u){console.error("Error analyzing transactions:",u)}finally{g(!1)}})()},[e,r]);const D=(p,u)=>{c(u)},k=j.useMemo(()=>{if(!e.length)return[];const p=new Map;return e.forEach(u=>{u.sku&&(p.has(u.sku)||p.set(u.sku,{sku:u.sku,description:u.description||u.sku}))}),Array.from(p.values())},[e]),R=async p=>{var u;try{const T=(u=p.target.files)==null?void 0:u[0];if(!T)throw new Error("No file selected");const I=await new Se(T).extract();await n(he(I)).unwrap(),p.target.value=""}catch{}};return t.jsx(J,{maxWidth:"xl",sx:{py:3},children:t.jsxs(N,{sx:{p:3,mb:4,borderRadius:2},children:[t.jsxs(S,{sx:{display:"flex",alignItems:"center",mb:3},children:[t.jsx(X,{sx:{fontSize:32,mr:2,color:"primary.main"}}),t.jsx(y,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"primary.dark"},children:"Transaction Analytics"}),e.length>0&&t.jsx(w,{label:`${e.length} Transactions`,color:"primary",size:"medium",sx:{ml:2}}),t.jsx(S,{sx:{flexGrow:1}}),(s||b)&&t.jsxs(S,{sx:{display:"flex",alignItems:"center",mr:2},children:[t.jsx(Y,{size:24,sx:{mr:1},color:"primary"}),t.jsx(y,{color:"primary.main",children:s?"Processing...":"Analyzing prices..."})]})]}),t.jsx(Z,{sx:{mb:3}}),t.jsx(ee,{sx:{mb:3,borderRadius:2,border:"1px solid",borderColor:l.minDate?"info.light":"divider"},children:t.jsxs(te,{children:[t.jsxs(S,{sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(re,{sx:{color:"info.main",mr:1}}),t.jsx(y,{variant:"h6",sx:{fontWeight:"bold",color:"info.dark"},children:l.minDate?t.jsx(t.Fragment,{children:"Transaction Period"}):t.jsx(t.Fragment,{children:"No Transactions Available"})})]}),l.minDate?t.jsxs(y,{variant:"body1",children:["Analyzing transactions from"," ",t.jsx("strong",{children:(A=l.minDate)==null?void 0:A.toDateString()})," to"," ",t.jsx("strong",{children:(E=l.maxDate)==null?void 0:E.toDateString()})]}):t.jsx(y,{variant:"body1",color:"text.secondary",children:"Upload a transaction file to begin analysis"})]})}),t.jsxs(h,{container:!0,spacing:2,sx:{mb:3},children:[t.jsx(h,{item:!0,xs:12,sm:6,children:t.jsxs(U,{variant:"contained",component:"label",disabled:s,startIcon:t.jsx(se,{}),fullWidth:!0,sx:{py:1.5,fontWeight:"medium"},children:["Upload Transaction File",t.jsx("input",{type:"file",hidden:!0,accept:".csv,.xlsx",onChange:R})]})}),t.jsx(h,{item:!0,xs:12,sm:6,children:t.jsx(U,{variant:"contained",color:"secondary",onClick:()=>C("/products"),disabled:!k.length,startIcon:t.jsx(ae,{}),fullWidth:!0,sx:{py:1.5,fontWeight:"medium"},children:"Manage Product Prices"})})]}),a&&t.jsx(oe,{severity:"error",sx:{mb:3},children:a}),o&&t.jsxs(t.Fragment,{children:[t.jsx(me,{summary:o}),t.jsx(S,{sx:{mt:4,mb:2},children:t.jsx(S,{sx:{borderBottom:1,borderColor:"divider"},children:t.jsxs(ie,{value:i,onChange:D,sx:{"& .MuiTab-root":{fontWeight:"bold"},"& .Mui-selected":{color:"primary.main"},"& .MuiTabs-indicator":{backgroundColor:"primary.main"}},children:[t.jsx(z,{label:"Orders"}),t.jsx(z,{label:"Product Details"})]})})}),t.jsx(B,{value:i,index:0,children:t.jsx(xe,{transactions:(o==null?void 0:o.analyzedTransactions)||[]})}),t.jsx(B,{value:i,index:1,children:t.jsx(ge,{transactions:e,summary:o})})]}),!o&&!s&&t.jsxs(S,{sx:{textAlign:"center",py:5},children:[t.jsx(y,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No transaction data available"}),t.jsx(y,{variant:"body1",color:"text.secondary",children:"Upload a transaction file to view analytics"})]})]})})};export{Ae as TransactionAnalytics};
